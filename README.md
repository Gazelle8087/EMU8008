# EMU8008

8008実CPUを動作させてみました。  
PICにてクロック生成 ROM/RAM UART および割込みコントローラーの  
機能を実現し2チップ構成としました。  

8008定格の500kHzで SCELBAL BASIC を動作させています。

![外観](https://github.com/Gazelle8087/EMU8008/blob/main/EMU8008%E9%83%A8%E5%93%81%E5%AE%9F%E8%A3%85%E4%BE%8B.jpg)

## ビルド環境
PIC ファームウエア  
IDE: MPLAB X v6.25  
Compiler: MPLAB XC8 v3.0  

8008 アセンブラ
Macro assembler  AS V1.42 Beta [Bld 290]  

PICのファームウエアのビルドに必要なファイルは  
EMU8008.c と sc1.txt のみです。

## プリント基板

EMU8008_100.zipはJLCPCBに発注した基板データです。  
設計時の配慮不足で、8008用のゼロプレッシャソケットのピンに対し穴が小さく  
うまく入りません。スルーホール内面のメッキを残しつつリーマ加工が必要です。  

![表](https://github.com/Gazelle8087/EMU8008/blob/main/EMU8008%E5%9F%BA%E6%9D%BF%E8%A1%A8%E9%9D%A2.jpg)
![裏](https://github.com/Gazelle8087/EMU8008/blob/main/EMU8008%E5%9F%BA%E6%9D%BF%E8%A3%8F%E9%9D%A2.jpg)

## 回路の説明

回路図からおわかりのように8008のピンとPICのピンを直結しています。  

8008のLレベルが 0V以下(先達の経験によると-1V程度）になることに対しては  
PICの入力がクランプダイオード内蔵であることと  
データシートよりクランプ電流は1mA未満と見積り  
素人工作レベルでは直結で問題しと判断しました。  

8008のHレベル出力に関してはPIC側の入力をWPU ONとして対応しました。  
WPU ONを十分Lにするだけのバス駆動力が8008にあるかどうかは  
PIC側の要求仕様が不詳のため不明でしたが、試行結果OKで決めました。  
  
なお、WPU OFFだと入力閾値をTTLレベルとしても動作しませんでした。  
問題なのがH側なのかL側なのかは切り分けできていません。

また、少々乱暴ですが8008のステータス出力(SYNC,S1,S1,S2)に  
直接LEDを接続しています。Hレベル駆動能力 0.2mAに対して、  
電流制限抵抗47kΩの場合0.05mA程度の負荷のため問題なしと判断しました。  

超高輝度LEDの中でも緑色(秋月販売コード 111635)は特に明るく  
このような用途にも使えて便利です。  

## PIC側ファームウエアについて

8008のステータス信号をφ21の立下りエッジでサンプリングし  
T1(通常命令の最初のステート)とT1I(割込みシーケンスの最初のステート)  
にて割込みをかけ、その後SYNCとCLK1見ながらアドレス読み込み保持、  
データ入出力タイミングを合わせました。  

8008のクロックが500kHzと低速なためウエイト不要でした。  

## 8008割込み処理および任意命令の連続実行について

8008にはRESET端子が無く、電源投入直後はHLT状態でINT待ちになっています。  
そのためCPU起動にはINTを制御し割込みコントローラーの機能を  
PICファームウエアで実現する必要があります。  

本ファームウエアでは、割込みシーケンスにおいて、INTをHのままにしておいて  
命令を順次CPUに読み込ませることにより、任意命令の連続実行を可能としています。  
また、割込み連続実行中はT1I,T2ステートでデータバスに出力される値を  
メモリ上にログとして順次記録します。  

本ファームウエアではOUT 8にてソフトウエアから割り込みを発生させることが出来、  
OUT 9にてINT=Lとし、通常動作(メモリ上の命令を実行)に戻ります。  
この機能により、例えば RETを8回連続実行させれば、メモリ上にCPU内部のスタックの  
内容を読み出すことができます。  
また、CALL命令を連続実行させると任意の値をスタックに書き込むことができます。  

8008はソフトウエアからはCPU内部のコールスタックの値を参照・書き込みできず  
その参照・操作のためにはなんらか外部ハードの助けが必要なのですが  
マイコンで外部回路機能をエミュレートすることにより柔軟な機能を実現できました。  
この機能は今後開発予定の機械語モニタで活用予定です。  

## 今後実装予定の機能について

【HLT実行割込み】  
8008のHLTステートを検出したら、PIC側から割込みをかけ  
レジスタ、フラグ、スタックを退避させたのちにモニタのブレーク処理アドレスに  
ジャンプさせます。  

【ブレークポイント機能】  
T2ステートにて命令実行アドレスがブレークアドレスと同一の場合  
命令コードをHLTにすり替えて8008に渡し強制ブレークさせます。  
このことによりROM上にもブレークポイント設定可能とします。  

【データスタック】  
8008はPUSH/POP命令が無く、さらにメモリに即値アドレスでアクセスできないため  
サブルーチン内でレジスタ退避ができません。  
そこで特定IOポートの読み書きでデータをPUSH/POPできるようにします。  

【7SEG LEDへの8008からの簡単アクセス】  
特定のアドレスをVRAMとみなし、PICの割込み待ち時間を使って  
7SEG LEDにSPIにてデータ転送し8008から7SEG LED表示を簡単にできるようにし、  
TK-80の7SEG LEDと同様の操作性を目指します。  

## ライセンス

PICのファームウエアと基板設計データはMITとします。

SCELBAL BASICに関しては私が改変した部分につきましてはMITライセンスとします。  
元のSCELBALに関しては非商用に限り利用可のようです  
詳細は参照元サイトをご覧ください。  

## 8008 CPU について

データシートは以下リンクを参照ください。  
http://www.bitsavers.org/components/intel/MCS8/Intel_8008_8-Bit_Parallel_Central_Processing_Unit_Rev1_Apr72.pdf

8008ファンさんのサイトです。  
割込みによる任意命令実行とスタック操作のアイデアをいただきました。  
日本語のサイトの中では最も情報が充実していると思います。  
http://www.mars.dti.ne.jp/~mark08/index.html

半導体コレクション展示会場  
他のCPUと共に詳細に解説されています。  
http://www.st.rim.or.jp/~nkomatsu/intel8bit/i8008.html

## 8008 CPU 搭載ミニコン SCELBIについて

詳細な資料が集約されています。  
https://www.scelbi.com/

実数型 SCELBAL BASIC はソース含め公開されています。  
https://www.willegal.net/scelbi/the8008andScelbi.html

## 8008実機動作事例

Ryo MukaiさんがTangNanoで8008を動作させています。  
ASCIIARTのBASICソースもこちらからいただきました。  
https://github.com/ryomuk/tangnano-5V/tree/main/applications/TangNano8008MEM

## EMUZ80について

電脳伝説さん制作のZ80をPICで駆動するSBCで本製作の発想のベースとなってます。
https://vintagechips.wordpress.com/2022/03/05/emuz80_reference/

## 基板頒布について

ご興味があり送付先開示しても問題ない方はご連絡いただければ  
普通郵便でよろしければ差し上げます。在庫4枚あります。  
競合した場合（ないと思いますが）は先着順とさせていただきます。

## 変更履歴
2025/07/26 Rev. 1.00 初回公開  

